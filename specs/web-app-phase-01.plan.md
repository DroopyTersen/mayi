# Phase 1: Web App Scaffolding

> **Status**: Ready to Start
> **Depends on**: Phase 0 (Server-Safe Engine) ✅ Complete
> **Estimated scope**: Add RR7 + Cloudflare Workers + PartyServer to existing project

## Phase 0 Complete

The GameEngine wrapper (`core/engine/game-engine.ts`) is complete and provides:
- ID-based commands (not position-based)
- Full serialization via `getPersistedSnapshot()` / `fromPersistedSnapshot()`
- PlayerView with per-player information hiding
- Zero Node.js dependencies (runs on Cloudflare Workers)

---

## Goal

Create a minimal web app that:
1. Serves a home page with "Create Game" / "Join Game"
2. Serves a game page that connects via WebSocket
3. Receives "CONNECTED" message from server
4. No game logic yet - just proving the stack works

## Approach

**Integrate directly into the existing project** - no monorepo, no separate package.json. Config files go at project root, new folders for app code.

### Reference the Template

Scaffold the Cloudflare React Router template to a temp directory for reference:

```bash
bun create cloudflare@latest -- /tmp/rr7-template --framework=react-router --no-deploy
```

Then cherry-pick files and adapt them to our project structure.

## Project Structure (After Phase 1)

```
mayi/
├── app/                         # NEW: React Router app
│   ├── routes.ts                # Route definitions
│   ├── root.tsx                 # Root layout
│   ├── app.css                  # Styles (Tailwind from template)
│   ├── entry.server.tsx         # SSR entry
│   └── routes/
│       ├── home.tsx             # / - create/join UI
│       └── game.$roomId.tsx     # /game/:roomId - WebSocket test
│
├── workers/                     # NEW: Cloudflare Worker entry
│   └── app.ts                   # Handles RR7 + PartyServer routing
│
├── party/                       # NEW: PartyServer rooms
│   └── mayi-room.ts             # MayIRoom Durable Object stub
│
├── core/                        # EXISTING: Game engine
├── cli/                         # EXISTING: CLI harness
├── ai/                          # EXISTING: AI agent
├── docs/                        # EXISTING: Documentation
├── specs/                       # EXISTING: Planning
│
├── public/                      # NEW: Static assets
│   └── favicon.ico
│
├── vite.config.ts               # NEW: Vite + Cloudflare + RR7
├── react-router.config.ts       # NEW: RR7 config
├── wrangler.jsonc               # NEW: Cloudflare Workers config
│
├── tsconfig.json                # MODIFY: Add DOM lib, project refs
├── tsconfig.web.json            # NEW: For app/, workers/
├── tsconfig.node.json           # NEW: For vite.config.ts
│
├── package.json                 # MODIFY: Add web dependencies
└── ...
```

## Files to Create/Modify

### From Template (copy and adapt)

| Template File | Project Location | Notes |
|---------------|------------------|-------|
| `vite.config.ts` | `vite.config.ts` | Copy as-is |
| `react-router.config.ts` | `react-router.config.ts` | Copy as-is |
| `app/entry.server.tsx` | `app/entry.server.tsx` | Copy as-is |
| `app/root.tsx` | `app/root.tsx` | Copy as-is |
| `app/app.css` | `app/app.css` | Copy as-is |
| `public/favicon.ico` | `public/favicon.ico` | Copy as-is |
| `worker-configuration.d.ts` | `worker-configuration.d.ts` | Generated by wrangler |

### New Files

| File | Purpose |
|------|---------|
| `wrangler.jsonc` | Cloudflare config with DO binding |
| `workers/app.ts` | Worker entry with PartyServer routing |
| `party/mayi-room.ts` | PartyServer stub |
| `app/routes.ts` | Route definitions |
| `app/routes/home.tsx` | Create/join UI |
| `app/routes/game.$roomId.tsx` | WebSocket test page |
| `tsconfig.web.json` | TypeScript config for web code |
| `tsconfig.node.json` | TypeScript config for vite.config |

### Modify Existing

| File | Changes |
|------|---------|
| `package.json` | Add web dependencies and scripts |
| `tsconfig.json` | Add project references |

## Implementation Details

### 1. `package.json` - Add dependencies and scripts

```bash
# Add web dependencies
bun add react react-dom react-router isbot
bun add -d @react-router/dev @cloudflare/vite-plugin vite vite-tsconfig-paths wrangler tailwindcss @tailwindcss/vite @types/react @types/react-dom

# Add PartyServer
bun add partyserver partysocket nanoid
```

Add scripts:
```json
{
  "scripts": {
    "dev": "react-router dev",
    "build": "react-router build",
    "preview": "bun run build && vite preview",
    "deploy": "bun run build && wrangler deploy",
    "cf-typegen": "wrangler types"
  }
}
```

### 2. `tsconfig.json` - Add project references

```json
{
  "files": [],
  "references": [
    { "path": "./tsconfig.web.json" },
    { "path": "./tsconfig.node.json" }
  ],
  "compilerOptions": {
    "strict": true,
    "skipLibCheck": true,
    "noEmit": true,
    "verbatimModuleSyntax": true
  }
}
```

### 3. `tsconfig.web.json` - For app/ and workers/

```json
{
  "extends": "./tsconfig.json",
  "include": [
    ".react-router/types/**/*",
    "app/**/*",
    "workers/**/*",
    "party/**/*",
    "core/**/*",
    "worker-configuration.d.ts"
  ],
  "compilerOptions": {
    "composite": true,
    "lib": ["DOM", "DOM.Iterable", "ES2022"],
    "types": ["vite/client"],
    "target": "ES2022",
    "module": "ES2022",
    "moduleResolution": "bundler",
    "jsx": "react-jsx",
    "baseUrl": ".",
    "rootDirs": [".", "./.react-router/types"],
    "paths": {
      "~/*": ["./app/*"]
    },
    "esModuleInterop": true,
    "resolveJsonModule": true
  }
}
```

### 4. `tsconfig.node.json` - For vite.config.ts

```json
{
  "extends": "./tsconfig.json",
  "include": ["vite.config.ts"],
  "compilerOptions": {
    "composite": true,
    "types": ["node"],
    "lib": ["ES2022"],
    "target": "ES2022",
    "module": "ES2022",
    "moduleResolution": "bundler"
  }
}
```

### 5. `vite.config.ts` - From template

```typescript
import { reactRouter } from "@react-router/dev/vite";
import { cloudflare } from "@cloudflare/vite-plugin";
import tailwindcss from "@tailwindcss/vite";
import { defineConfig } from "vite";
import tsconfigPaths from "vite-tsconfig-paths";

export default defineConfig({
  plugins: [
    cloudflare({ viteEnvironment: { name: "ssr" } }),
    tailwindcss(),
    reactRouter(),
    tsconfigPaths(),
  ],
});
```

### 6. `react-router.config.ts` - From template

```typescript
import type { Config } from "@react-router/dev/config";

export default {
  ssr: true,
  future: {
    v8_viteEnvironmentApi: true,
  },
} satisfies Config;
```

### 7. `wrangler.jsonc` - Cloudflare config

```jsonc
{
  "$schema": "node_modules/wrangler/config-schema.json",
  "name": "mayi",
  "compatibility_date": "2025-04-04",
  "main": "./workers/app.ts",
  "durable_objects": {
    "bindings": [
      { "name": "MayIRoom", "class_name": "MayIRoom" }
    ]
  },
  "migrations": [
    { "tag": "v1", "new_sqlite_classes": ["MayIRoom"] }
  ],
  "observability": { "enabled": true }
}
```

### 8. `workers/app.ts` - Worker entry

```typescript
import { createRequestHandler } from "react-router";
import { routePartykitRequest } from "partyserver";

export { MayIRoom } from "../party/mayi-room";

declare module "react-router" {
  export interface AppLoadContext {
    cloudflare: { env: Env; ctx: ExecutionContext };
  }
}

const requestHandler = createRequestHandler(
  () => import("virtual:react-router/server-build"),
  import.meta.env.MODE
);

export default {
  async fetch(request, env, ctx) {
    // Try PartyServer first (WebSocket upgrades)
    const partyResponse = await routePartykitRequest(request, env);
    if (partyResponse) return partyResponse;

    // Fall through to React Router
    return requestHandler(request, { cloudflare: { env, ctx } });
  },
} satisfies ExportedHandler<Env>;
```

### 9. `party/mayi-room.ts` - PartyServer stub

```typescript
import { Server, type Connection, type ConnectionContext } from "partyserver";

export class MayIRoom extends Server {
  static options = { hibernate: true };

  onConnect(conn: Connection, ctx: ConnectionContext) {
    conn.send(JSON.stringify({
      type: "CONNECTED",
      roomId: this.name,
      message: "Phase 1 stub - no game logic yet"
    }));
  }

  onMessage(conn: Connection, message: string) {
    conn.send(JSON.stringify({
      type: "ECHO",
      received: message
    }));
  }
}
```

### 10. `app/routes.ts` - Route definitions

```typescript
import { type RouteConfig, index, route } from "@react-router/dev/routes";

export default [
  index("routes/home.tsx"),
  route("game/:roomId", "routes/game.$roomId.tsx"),
] satisfies RouteConfig;
```

### 11. `app/routes/home.tsx` - Create/join UI

```typescript
import { Form, redirect } from "react-router";
import { nanoid } from "nanoid";
import type { Route } from "./+types/home";

export function meta() {
  return [{ title: "May I?" }];
}

export async function action({ request }: Route.ActionArgs) {
  const formData = await request.formData();
  const intent = formData.get("intent");

  if (intent === "create") {
    return redirect(`/game/${nanoid(8)}`);
  }

  if (intent === "join") {
    const roomId = formData.get("roomId");
    if (roomId && typeof roomId === "string") {
      return redirect(`/game/${roomId}`);
    }
  }
  return null;
}

export default function Home() {
  return (
    <main className="flex flex-col items-center justify-center min-h-screen gap-8">
      <h1 className="text-4xl font-bold">May I?</h1>

      <Form method="post">
        <input type="hidden" name="intent" value="create" />
        <button type="submit" className="px-6 py-3 bg-blue-600 text-white rounded-lg">
          Create New Game
        </button>
      </Form>

      <Form method="post" className="flex gap-2">
        <input type="hidden" name="intent" value="join" />
        <input type="text" name="roomId" placeholder="Room ID" className="px-4 py-2 border rounded-lg" />
        <button type="submit" className="px-4 py-2 bg-gray-600 text-white rounded-lg">Join</button>
      </Form>
    </main>
  );
}
```

### 12. `app/routes/game.$roomId.tsx` - WebSocket test

```typescript
import type { Route } from "./+types/game.$roomId";
import usePartySocket from "partysocket/react";
import { useState } from "react";

export function meta({ params }: Route.MetaArgs) {
  return [{ title: `Game: ${params.roomId}` }];
}

export async function loader({ params }: Route.LoaderArgs) {
  return { roomId: params.roomId };
}

export default function Game({ loaderData }: Route.ComponentProps) {
  const { roomId } = loaderData;
  const [status, setStatus] = useState("Connecting...");
  const [messages, setMessages] = useState<string[]>([]);

  const socket = usePartySocket({
    host: typeof window !== "undefined" ? window.location.host : "",
    room: roomId,
    party: "may-i-room",

    onOpen() { setStatus("Connected"); },
    onMessage(event) { setMessages(prev => [...prev, event.data]); },
    onClose() { setStatus("Disconnected"); },
  });

  return (
    <main className="p-8">
      <h1 className="text-2xl font-bold mb-4">Game: {roomId}</h1>
      <p className="mb-4">Status: <span className="font-mono">{status}</span></p>

      <button
        onClick={() => socket?.send(JSON.stringify({ type: "TEST", timestamp: Date.now() }))}
        className="px-4 py-2 bg-blue-600 text-white rounded mb-8"
      >
        Send Test Message
      </button>

      <h2 className="text-xl font-bold mb-2">Messages</h2>
      <ul className="space-y-2">
        {messages.map((msg, i) => (
          <li key={i} className="font-mono bg-gray-100 p-2 rounded">{msg}</li>
        ))}
      </ul>
    </main>
  );
}
```

## Tasks

1. [ ] Scaffold template to `/tmp/rr7-template` for reference
2. [ ] Add dependencies to `package.json`
3. [ ] Create `tsconfig.web.json` and `tsconfig.node.json`
4. [ ] Update `tsconfig.json` with project references
5. [ ] Create `vite.config.ts` (from template)
6. [ ] Create `react-router.config.ts` (from template)
7. [ ] Create `wrangler.jsonc` with DO binding
8. [ ] Create `workers/app.ts` with PartyServer routing
9. [ ] Create `party/mayi-room.ts` stub
10. [ ] Copy `app/entry.server.tsx`, `app/root.tsx`, `app/app.css` from template
11. [ ] Create `app/routes.ts`
12. [ ] Create `app/routes/home.tsx`
13. [ ] Create `app/routes/game.$roomId.tsx`
14. [ ] Copy `public/favicon.ico` from template
15. [ ] Run `bun install`
16. [ ] Run `bun run cf-typegen` to generate worker types
17. [ ] Verify `bun run dev` starts
18. [ ] Verify WebSocket connection works

## Verification

```bash
bun run dev
```

- Navigate to http://localhost:5173/
- Click "Create New Game" → redirects to /game/[id]
- Status shows "Connected"
- Message list shows `{"type":"CONNECTED",...}`
- "Send Test Message" → shows `{"type":"ECHO",...}`

## Notes

### TypeScript Strategy

The project now uses project references:
- `tsconfig.json` - Root config (references only)
- `tsconfig.web.json` - For app/, workers/, party/, core/ (includes DOM)
- `tsconfig.node.json` - For vite.config.ts (Node types)

The existing `tsgo --noEmit` typecheck will need updating to handle project references, or we switch to `tsc -b`.

### Scripts

```bash
bun run dev       # Start Vite dev server
bun run build     # Build for production
bun run deploy    # Deploy to Cloudflare
bun run cf-typegen # Generate worker-configuration.d.ts
```

### Party Name Convention

`routePartykitRequest` converts DO binding to kebab-case:
- Binding: `MayIRoom` → party: `may-i-room`

### Same-Origin WebSocket

RR7 and PartyServer share the same Worker - no CORS needed.
