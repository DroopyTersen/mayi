# Review: Lobby Auto-Join Avatar + Model Mapping

Date: 2026-01-15

## Context

This review covers two regressions in the lobby join flow (auto-join + change-name) and a follow-up discussion about AI model mapping for an MVP.

## Reviewer Findings (Functional Regressions)

### P1: Auto-join ignores stored/required avatar selection

**Symptom**
- Returning users with a stored name could be auto-joined immediately on websocket `onopen` without an `avatarId`, bypassing the character picker entirely.
- In the common upgrade case (stored name exists from a prior version, but no stored avatar), users would join as “nameless avatar” (server stores them without an avatar) and never get a chance to pick a persona.

**Root cause**
- `app/routes/game.$roomId.tsx` auto-joined based solely on `getStoredPlayerName()`, calling `sendJoin(playerId, storedName)` without:
  - using `getStoredAvatarId()`, or
  - gating auto-join on whether an avatar has ever been chosen.
- Reconnect resync (`handleReconnect`) also resent `JOIN` without `avatarId`.
- `JOINED` messages do not include `avatarId`, so the client must persist it locally and include it in `JOIN` messages to keep the server-side presence state correct.

### P2: Name change dialog blocks keeping your current avatar

**Symptom**
- Opening the “Change Name” dialog could disable the current player’s avatar in the character picker (because it was treated as “taken”).
- This forced users to switch characters just to re-confirm or “change name”.

**Root cause**
- The `takenCharacterIds` list included *all* human + AI avatars, including the current user’s avatar, and `CharacterPicker` disables taken IDs.
- `NamePromptDialog` submits on selection, so if the current avatar is disabled it cannot be re-selected to re-submit.

## Fixes Applied

### Auto-join now requires both stored name and stored avatar
- `app/routes/game.$roomId.tsx`
  - `onopen`: auto-joins only when both `getStoredPlayerName()` and `getStoredAvatarId()` are present; otherwise shows the character picker.
  - `handleReconnect`: re-sends `JOIN` with `avatarId` when available.

### Name prompt no longer treats your own avatar as “taken”
- `app/ui/lobby/LobbyView.tsx`
  - Computes `takenCharacterIdsForNamePrompt` by excluding `currentPlayerAvatarId`.
  - Uses this filtered list only for `NamePromptDialog`, while leaving the full taken list for adding AI players.

## MVP Note: Model Mapping / “Map Everything to Grok”

There was a request to simplify the MVP by mapping all model requests to Grok and removing model mapping entirely. That change was explicitly undone: **the codebase continues to support multiple AI providers/models**.

Current multi-model support lives in:
- `ai/modelRegistry.ts` (provider registry + named `default:*` aliases)
- `app/party/ai-model-factory.ts` (worker-compatible factory; parses `provider:model` and maps `default:*` aliases)
- `app/party/ai-models.ts` and `app/party/protocol.types.ts` (enumeration of allowed `default:*` model IDs for the web lobby)
- `app/ui/lobby/AddAIPlayerDialog.tsx` and `cli/interactive/interactive.ts` (model selection UI)

Future note: we may later add a field to bind characters/personas to different LLMs (e.g., “this avatar uses this model”), but that is intentionally **not** part of the current MVP behavior.

## Next Fixes (Implemented)

1) **Handle stored-avatar conflicts gracefully** (implemented)
- If a user has a stored avatar that is already taken in the room, auto-join will currently attempt and then fall back via the generic `ERROR` handler.
- Improvement: detect the “avatar taken”/conflict error explicitly, clear the stored avatar, and open the picker immediately (so the user isn’t stuck retrying the same taken avatar).

2) **Use stored avatar to preselect after join failures** (implemented)
- If join fails before the player appears in `players`, `LobbyView` can’t derive `defaultAvatarId` from `currentPlayerAvatarId`.
- Improvement: plumb `storedAvatarId` from `app/routes/game.$roomId.tsx` into `LobbyView`/`NamePromptDialog` as a fallback default selection.

3) **Fix UI copy** (implemented)
- The flow is character/persona selection, not free-form naming.
- Improvement: rename “Join Game”/“Change Name” labels and dialog copy to “Choose Character”/“Change Character” (or “Persona”) to match behavior.

## Follow-up: Reconnect “Lobby Flash” Bug (Fixed)

**Observed**
- On brief connectivity blips, the app could “jump” back to the lobby and show the character picker even though the game was still in progress.
- Picking the same character would then re-`JOIN` and the server would send `GAME_STARTED`, snapping the UI back into the game mid-round.

**Root cause**
- `app/routes/game.$roomId.tsx` computed `storedName`/`initialStoredAvatarId` once when the effect ran, and the `newSocket.onopen` handler reused those stale values on subsequent reconnect opens. After a user first chose a character (writing to localStorage), reconnect opens could still behave as if no stored identity existed.

**Fix**
- `newSocket.onopen` now reads `getStoredPlayerName()` / `getStoredAvatarId()` at the time of the open event.
- When already joined or in-game, `onopen` no longer mutates lobby UI state; resync is handled via `usePartyConnection`’s `onReconnect` callback.
