# Plan: Rewrite Mobile HandDrawer From Scratch (Vaul “Default”)

## Context

Today mobile uses `app/ui/hand-drawer/HandDrawer.tsx` (Vaul) and `app/ui/game-view/GameView.tsx` to show the player’s hand at the bottom of the screen.

The current implementation is hard to reason about and buggy because it:

- Keeps the drawer **always open** and tries to emulate “closed/peek/half/full” via **snap points**.
- Adds a **custom overlay** and custom snap-point state machine.
- Disables interactions via `pointer-events-none` when “minimized”.
- Requires the main page to reserve space for a “drawer” using a Tailwind class that is currently **dynamic** (`pb-[${...}px]`) and therefore **not generated by Tailwind**, so the table can end up hidden behind the fixed drawer.

We already have a generic `ResponsiveDrawer` (`app/ui/responsive-drawer/ResponsiveDrawer.tsx`) that uses Vaul on mobile and Radix Dialog on desktop, but the mobile hand UI bypasses it and uses Vaul directly.

## Rewrite Strategy (Throw It Away)

This is intentionally a **rewrite**, not a refactor:

- Do **not** try to keep any snap point logic, custom overlay logic, or “minimized/half/expanded” state machine.
- The only “peek” behavior we keep is visual: a fixed bar that previews the hand and acts as the trigger.
- Implementation should match Vaul’s docs “Default” drawer pattern: `Drawer.Root` + `Drawer.Trigger` + `Drawer.Portal` + `Drawer.Overlay` + `Drawer.Content`.

## Goal (User-Facing)

On phones:

1. The user can always see the **table**.
2. The user can always see their **hand “peeking out”** at the bottom (a small, fixed “peek bar”).
3. Tapping the peek bar opens a **standard Vaul drawer** where the user can:
   - see and select cards in their hand
   - take actions (draw, discard, lay down, etc.)
4. The implementation should be “docs-default” Vaul: **open/close only**, no snap points, no custom overlay logic, minimal state.

On tablet/desktop:

- Keep existing behavior (fixed bottom area + `ResponsiveDrawer` for modal views).

## Non-Goals

- Do not re-introduce snap points or partial-open states.
- Do not redesign the overall game layout; keep changes localized to mobile hand UI.
- Do not change game rules / action availability logic.

## Proposed UX (Mobile)

### Closed state (“Peek”)

- A fixed bar is anchored to the bottom of the viewport.
- It visually looks like the top edge of a drawer (rounded top + grabber).
- It shows a cropped preview of the player’s hand (top portion of cards) so it looks like the hand is “peeking”.
- The peek bar is a single `button` (or `Drawer.Trigger`) so tapping anywhere opens the drawer.
- No card interaction in peek mode (peek is preview only).

### Open state

- Standard Vaul overlay + content sheet.
- Content includes:
  - drag handle / grabber (optional but nice)
  - full `HandDisplay` with `onCardClick`
  - selection count (optional)
  - action controls (`ActionBar`) (required)
  - optional: discard/stock piles row (keep if it’s important; otherwise omit for simplicity)
- Closing:
  - swipe down to close (Vaul default)
  - tap overlay to close (Vaul default)
  - optional explicit close button (not required)

## Technical Design

### 1) Rebuild `HandDrawer.tsx` using the Vaul “Default” pattern

File: `app/ui/hand-drawer/HandDrawer.tsx`

Implementation requirements:

- **Use Vaul directly**: `import { Drawer } from "vaul"`.
- Use a **controlled** drawer so `GameView` can close it when switching to other “view drawers”:
  - `Drawer.Root open={open} onOpenChange={onOpenChange}`
- Use a fixed “peek bar” as the `Drawer.Trigger`:
  - When closed: the peek bar is visible and tappable.
  - When open: the peek bar should be hidden (to avoid stacking UI under the drawer).
- Use the default Vaul sheet structure:
  - `Drawer.Portal` (support `container` for Storybook)
  - `Drawer.Overlay` (tap to close)
  - `Drawer.Content` (sheet)

#### Minimal code skeleton (copy/paste starting point)

Use this as the initial structure before styling/polish:

```tsx
import { Drawer } from "vaul";

export const MOBILE_HAND_PEEK_HEIGHT_PX = 104;

export function HandDrawer({ open, onOpenChange, hand, selectedCardIds, onCardClick, onAction, availableActions, topDiscard, container }: HandDrawerProps) {
  return (
    <Drawer.Root open={open} onOpenChange={onOpenChange}>
      {!open && (
        <Drawer.Trigger asChild>
          <button type="button" aria-label="Open hand">Peek</button>
        </Drawer.Trigger>
      )}

      <Drawer.Portal container={container}>
        <Drawer.Overlay />
        <Drawer.Content>
          {/* handle */}
          {/* hand */}
          {/* actions */}
        </Drawer.Content>
      </Drawer.Portal>
    </Drawer.Root>
  );
}
```

Then progressively replace `Peek/Overlay/Content` with the actual UI and classes.

### 2) Implement the “peek bar”

The peek bar must:

- Be fixed: `position: fixed; left: 0; right: 0; bottom: 0`
- Have a predictable height so we can reserve space in the scrolling main content.
- Respect iOS safe area: pad bottom with `env(safe-area-inset-bottom)`.
- Be accessible:
  - `button` with `type="button"`
  - `aria-label="Open hand"` (or similar)
- Contain:
  - a grabber (small rounded bar)
  - a cropped `HandDisplay` preview

Implementation details for the preview crop:

- Render `HandDisplay` in a container with `overflow-hidden` and a fixed height.
- Force the cards to align to the top so we see the *top* of each card:
  - `HandDisplay` currently uses `items-end` internally.
  - Pass `className="justify-center items-start"` and rely on tailwind-merge to override `items-end`.
- Use a fixed card size for stability in the tiny preview: `size="sm"`.
- Do not pass `onCardClick` to the preview (so it’s not interactive).

Define a single source of truth for the reserved height:

- Export a constant from `HandDrawer.tsx`, e.g.:
  - `export const MOBILE_HAND_PEEK_HEIGHT_PX = 104;`
- Use it both:
  - to size the peek bar
  - to set bottom padding in `GameView`’s scroll container

### 3) Drawer content layout (open state)

Inside `Drawer.Content`:

- Use a flex column layout with:
  - header/handle area (shrink-0)
  - scrollable body for hand (flex-1 + `overflow-y-auto`)
  - footer for `ActionBar` (shrink-0)

Concrete layout suggestions:

- Add bottom padding inside content for safe area:
  - `pb-[calc(env(safe-area-inset-bottom)+12px)]`
- Ensure `ActionBar` is visible and not clipped:
  - If the body scrolls, keep `ActionBar` outside the scroll area.

### 4) Close the hand drawer before opening any other drawer/view

Problem to avoid:

- If the hand drawer stays open while opening `LayDownDrawer` / `ResponsiveDrawer` views, overlays and focus management can stack and feel broken.

Implementation options:

Option A (preferred): Lift open state to `GameView`.

- In `GameView` create:
  - `const [isHandDrawerOpen, setIsHandDrawerOpen] = useState(false)`
- Pass to `HandDrawer`:
  - `open={isHandDrawerOpen}`
  - `onOpenChange={setIsHandDrawerOpen}`
- In `handleAction`, before `setActiveDrawer(action)`, close the hand drawer:
  - `setIsHandDrawerOpen(false)`

Option B: Keep open state inside `HandDrawer` and add a prop like `onViewAction`.

- `HandDrawer` closes itself when `onAction` is one of: `layDown`, `layOff`, `discard`, `swapJoker`, `organize`.
- This duplicates the action list in 2 places; avoid if possible.

### 5) Fix mobile bottom padding in GameView (no dynamic Tailwind)

File: `app/ui/game-view/GameView.tsx`

Replace the current dynamic Tailwind padding:

- Current (buggy): ``isMobile && `pb-[${MOBILE_DRAWER_PADDING}px]``` (Tailwind cannot see this at build time)

With one of:

- Inline style using the exported peek height constant:
  - `style={{ paddingBottom: isMobile ? `calc(${MOBILE_HAND_PEEK_HEIGHT_PX}px + env(safe-area-inset-bottom))` : undefined }}`
- Or a static Tailwind arbitrary value class (only if the number is literal in source):
  - `pb-[calc(104px+env(safe-area-inset-bottom))]`

Pick inline style if you want a single shared constant without Tailwind safelisting concerns.

### 6) Update storybook example(s)

File: `app/ui/hand-drawer/HandDrawer.story.tsx`

- Rename the story to reflect the new behavior (“Default Vaul Drawer”).
- Update the explanation text:
  - Remove snap point descriptions.
  - Document: peek bar → tap to open → swipe down / tap overlay to close.
- Keep the fullscreen test story if it’s still useful, but it should now work in containers too (no snap points).

### 7) Cleanup

- Remove snap-point-specific code and types from `HandDrawer.tsx`:
  - `SNAP_POINTS`, `activeSnapPoint`, `fadeFromIndex`, custom overlay, `snapToSequentialPoint`, pointer-event toggles
- Remove unused constants like `MOBILE_DRAWER_PADDING` if replaced.

## Step-by-Step Implementation Checklist

### Step 0: Safety prep

- Create a new branch locally if desired (optional).
- Keep changes scoped to:
  - `app/ui/hand-drawer/HandDrawer.tsx`
  - `app/ui/game-view/GameView.tsx`
  - `app/ui/hand-drawer/HandDrawer.story.tsx`

### Step 1: Rewrite `HandDrawer.tsx` (do not salvage old code)

1. Open `app/ui/hand-drawer/HandDrawer.tsx` and delete everything in the file.
2. Recreate the file using the “Minimal code skeleton” above as the base.
3. Add the full props interface (`hand`, `selectedCardIds`, `onCardClick`, `onAction`, `availableActions`, `topDiscard`, `open`, `onOpenChange`, optional `container`).
4. Implement the peek bar UI:
   - `position: fixed` (or `absolute` when `container` is provided)
   - fixed height = `MOBILE_HAND_PEEK_HEIGHT_PX` + safe area
   - preview crop container = `overflow-hidden` with a small height (e.g. 48px)
5. Implement the drawer sheet UI:
   - overlay covers screen and closes on tap
   - content is bottom sheet with handle, scrollable body, and `ActionBar` footer
6. Keep the hand preview **non-interactive** (no `onCardClick` in peek mode).
7. Ensure there are **no** snap point props or custom overlay logic.

### Step 2: Update `GameView.tsx`

1. Import `MOBILE_HAND_PEEK_HEIGHT_PX` from `HandDrawer`.
2. Add state: `isHandDrawerOpen`.
3. Update `handleAction`:
   - For view actions (`layDown`, `layOff`, `discard`, `swapJoker`, `organize`):
     - call `setIsHandDrawerOpen(false)` before opening the view drawer
4. Replace mobile padding logic on the main scroll container:
   - Remove `MOBILE_DRAWER_PADDING` and the template string Tailwind class.
   - Add inline `style={{ paddingBottom: ... }}` using the constant and safe area env var.
5. Render `HandDrawer` with controlled props:
   - `open={isHandDrawerOpen}`
   - `onOpenChange={setIsHandDrawerOpen}`

### Step 3: Update `HandDrawer.story.tsx`

1. Update story title/description to match new design.
2. If `HandDrawer` now requires `open/onOpenChange`, add local state in the story.
3. Verify the story still demonstrates:
   - peek bar visible
   - tap opens drawer
   - swipe down closes

### Step 4: Manual QA checklist

On a phone-sized viewport:

- Table is visible above the peek bar.
- Peek bar shows a cropped hand preview.
- Tap peek bar opens drawer.
- Tap overlay closes drawer.
- Swipe down closes drawer.
- Selecting cards works when open.
- Tapping `Lay Down` / `Discard` / `Organize` closes hand drawer and opens the correct view drawer.
- No “double overlay” scenarios.

On desktop:

- Existing fixed bottom hand + piles + action bar still render.
- `ResponsiveDrawer` behavior unchanged.

### Step 5: Verification commands

Run:

- `bun run typecheck`
- `bun run build`

If storybook is used locally, manually verify the hand drawer story.
